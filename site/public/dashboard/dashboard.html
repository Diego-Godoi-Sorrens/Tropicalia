<!DOCTYPE html>
<html lang="pt-br">

<head>
    <!-- <link rel="shortcut icon" href="../assets/icon/favicon.ico" type="image/x-icon"> -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tropicália | Principais Artistas</title>

    <link rel="stylesheet" href="../css/dashboard.css">
    <script src="../js/funcoes.js"></script>
    <script src="../js/Funcionalidade.js"></script>


    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"rel="stylesheet">

    <!-- scripts do Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body onload="validarSessao(), ultimasAvaliacoes(()=> jogarDados(()=> setTimeout(atualizarGrafico, 2000)))">
<!-- <body>  -->

    <div class="banner">

        <div class="header_v">

            <button onclick="abrir_menu()" id="abrir-menu-dash" class="abrir-dash">
                <h1><a>☰</a></h1>
            </button>

            <div class="btn-sair" onclick="limparSessao()">
                <h3>sair</h3>
            </div>

        </div>

        <div class="header_h">
            <div class="btn-index" onclick="go_index()">
                <h3>Tropicália</h3>
            </div>
        </div>    
            
        <div class="container">

            <div class="lado">
                <div class="card_titulo"> <span class="inicial">P</span>rincipais  <span class="inicial">A</span>rtistas</div>

                <div class="card_artistas">
                    <div class="artista caetano" onclick="caetano_card()"> 
                        <!-- <img src="../assets/img/tropicalismo_img1.jpg">  -->
                    </div>

                    <div class="artista mutantes" onclick="mutantes_card()"> 
                        <!-- <img src="../assets/img/tropicalismo_img1.jpg">  -->
                    </div>

                    <div class="artista gil" onclick="gil_card()"> 
                        <!-- <img src="../assets/img/tropicalismo_img1.jpg">  -->
                    </div>

                    <div class="artista gal" onclick="gal_card()"> 
                        <!-- <img src="../assets/img/tropicalismo_img1.jpg">  -->
                    </div>
                </div>
            </div>

            <div class="lado">

                <div class="card_avaliacao">

                    <div class="card_titulo_1">Avalie nosso site:</div>

                    <div class="estrelas">
                        <div class="rating">
                            <button class="star">&#9734;</button>
                            <button class="star">&#9734;</button>
                            <button class="star">&#9734;</button>
                            <button class="star">&#9734;</button>
                            <button class="star">&#9734;</button>
                        </div>
                        <span class="current_rating">0 de 5</span>
                    </div>

                    <div class="card_grafico">
                        <canvas id="myChart" class="grafico"></canvas>
                    </div>
                </div>

            </div>

        </div>
    </div>

</body>

</html>

<script>

    const allStars = document.querySelectorAll('.star');
    let current_rating = document.querySelector ( '.current_rating' );

    allStars.forEach ((star, i) => {

        star.onclick = function () {

            var id_usuario = sessionStorage.ID_USUARIO 
            let current_star_level = i + 1;
            current_rating.innerHTML = `${current_star_level} de 5`;

            allStars.forEach ((star, j) => {

                if(current_star_level >= j + 1){
                    star.innerHTML = '&#9733;'
                }else{
                    star.innerHTML = '&#9734;'
                }

            })

            fetch("/usuarios/avaliacao", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    // crie um atributo que recebe o valor recuperado aqui
                    // Agora vá para o arquivo routes/usuario.js
                avaliacaoServer: current_star_level,
                idUsuarioServer: id_usuario             
                })
            }).then(function (resposta) {

                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    // cardErro.style.display = "block";

                    // mensagem_erro.innerHTML = "Cadastro realizado com sucesso! Redirecionando para tela de Login...";

                    // setTimeout(() => {
                    //     window.location = "../login.html";
                    // }, "2000")
                    
                    // limparFormulario();
                    // finalizarAguardar();
                } else {
                    throw ("Houve um erro ao tentar realizar a avaliação!");
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
                // finalizarAguardar();
            });

            return false;
        }
    })

    var listaAvaliacoes = [];

    function ultimasAvaliacoes(_callback) {

        fetch(`/usuarios/ultimasAvaliacoes/`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {

                response.json().then(function (resposta) {
                console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                for(var i = 0; i < 20; i++){
                    listaAvaliacoes[i] = resposta[i].avaliacao;
                }
                _callback();
                });

            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                _callback();
            }
        })

        .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });

    }

    function jogarDados(_callback){
        
        for (var i = 0 ; i < 20 ; i++){
            data.datasets[0].data.push(listaAvaliacoes[i])
            // console.log(listaAvaliacoes[i])
        }
        _callback();
    }

    function atualizarGrafico(){

        myChart.update();

    }


</script>

<script>
    const labels = [
      '1 estrela',
      '2 estrelas',
      '3 estrelas',
      '4 estrelas',
      '5 estrelas',
    ];
  
    const data = {
      labels: labels,
      datasets: [{
        label: 'Quantidade de avaliações',
        backgroundColor: '#2ba99d',
        borderColor: '#2ba99d',
        data: [],
      }]
    };
  
    const config = {
      type: 'bar',
      data: data,
      options: {}
    };

</script>

<script>
    const myChart = new Chart(
      document.getElementById('myChart'),
      config
    );
</script>
  